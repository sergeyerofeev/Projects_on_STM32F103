#### Bootloader на основе USB Mass Storage Device

#### Описание  

Пример для микроконтроллера STM32F103C8хх c объёмом flash памяти 64К (Black Pill).  

Загружаемая прошивка будет записываться начиная с адреса 0x08009000.

Flash память организована постранично, в данном случае микроконтроллер имеет 64 страницы, размер страницы 1024 байта.  

В примере под записываемые данные отведено 64 – 36 страниц. Первые 36 страниц, с 0 по 35 включительно, отведены непосредственно под код загрузчика.  

При подключении микроконтроллера к компьютеру по USB, обнаруженный внешний диск форматировать не нужно.  

Поскольку операционная система видит наше устройство как диск, просто запишем (стандартным ПО) на него наш bin файл прошивки. То есть, любая утилита, которая может заливать образ диска на флешку, сможет залить нашу прошивку. Мы просто подсунем программе вместо образа диска нашу прошивку в формате bin.  

Почему именно bin файл а не, скажем hex? Именно bin файл – бинарный файл, который фактически является дампом памяти для микроконтроллера.  

Дамп можно залить стандартной командой **dd** (под Ubuntu). Под Windows можно использовать популярное приложение **Win32DiskImager** для записи образа диска на Flash-носитель.  

### Как определить какой код выполнять?  

Мы подключаем вывод PB4 к +5V разъёма USB и по данному выводу будем контролировать:  
* Если на входе PB4 логическая единица, запускаем Mass Storage Device и ожидаем загрузки кода прошивки.
* Если при запуске микроконтроллера на выводе PB4 логический ноль, то выполняем перед на загруженную прошивку.

Для примера в папке Bin_firmware находится bin файл с прошивкой мигания светодиодом на выводе PB12.  

___